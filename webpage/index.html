<!DOCTYPE html>
<html>
	<head>
	<meta name="robots" content="noindex" />
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<title>Snow and Ice Data</title>
	<script type="text/javascript" src="jquery.js"></script>		
		
	<style type="text/css">
		/* clear all attributes */
		html, body, div, span, applet, object, iframe,h1, h2, h3, h4, h5, h6, p, blockquote, pre,a, abbr, acronym, address, big, cite, code,del, dfn, em, img, ins, kbd, q, s, samp,small, strike, strong, sub, sup, tt, var,b, u, i, center,dl, dt, dd, ol, ul, li,fieldset, form, label, legend,table, caption, tbody, tfoot, thead, tr, th, td,article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary,time, mark, audio, video {margin: 0;padding: 0;border: 0;font-size: 100%;font: inherit;vertical-align: baseline;}
		/* HTML5 display-role reset for older browsers */
		article, aside, details, figcaption, figure, footer, header, hgroup, menu, nav, section {display: block;}
		body {line-height: 1;}
		ol, ul {list-style: none;}
		blockquote, q {quotes: none;}
		blockquote:before, blockquote:after,
		q:before, q:after {content: '';content: none;}
		table {border-collapse: collapse;border-spacing: 0;}
		/* end css reset */
		a:visited, a:link { color: #909090;text-decoration: none; }
		.header {
			clear: both;
			margin-left: auto;
			margin-top: 30px;
			margin-bottom: 20px;
			margin-right: auto;
			width: 1200px;
			height: 50px;
			text-align: center;
			font-size: 36px;
			font-weight: 300;
			text-shadow: 0 1px 0 #fff;
		}
		.subtitle {
			color: rgb(153, 153, 153); 
			font-size: 12px;
		}
		.menu{
			clear: both;
			margin-left: auto;
			margin-right: auto;
			width: 1200px;
			height: 10px;
			margin-bottom: -5px;
		}
		#outputImageTemperature { float: left; width: 100%; text-align: left; }
		#outputImageCoordinates { float: left; width: 100%; text-align: left; }
		#outputImageMin { float: left; width: 100%; text-align: left; }
		#outputImageMax { float: left; width: 100%; text-align: left; }
		#fileLabelName { float: left; width: 100%; text-align: left; }
		.block {
			clear: both;
			margin-left: auto;
			margin-right: auto;
			width: 1200px;
			height: 650px;
			margin-top: 20px;
			color: #777;
			font-family: "Helvetica Neue", Helvetica;
		}
		.box {
			margin-left: 25px;
			margin-top: 25px;
		}
		.figureLeftExplorer {
			float: left;
			width: 250px;
			height: 600px;
			text-align: center;
			font-size: medium;
		}
		#imageInformation { width: 100%; margin: 10px; }
		.figureRightExplorer {
			float: left;
			position: relative;
			text-align: center;
			width: 875px;
			height: 600px;
		}
		.figureLeftSpark {
			float: left;
			position: relative;
			text-align: center;
			width: 875px;
			height: 600px;
		}
		.figureRightSpark {
			float: left;
			width: 250px;
			height: 600px;
			text-align: center;
			font-size: medium;
		}
		#regionField, #frequencyField, #polarizationField, #yearField, #monthField, #dayField {
			width: 100%;
			font-size: 13px;
		}
		#yearEntry, #monthEntry, #dayEntry { width: 20px; height: 12px; }
		.myButton {
			background-color:#ffffff;
			-moz-border-radius:7px;
			-webkit-border-radius:7px;
			border-radius:7px;
			border:1px solid #dcdcdc;
			display:inline-block;
			cursor:pointer;
			color:#666666;
			font-size:13px;
			padding:2px 20px;
			margin: 2px 3px 2px 3px;
			text-decoration:none;
		}
		.myButton:hover {
			background-color:#f6f6f6;
		}
		.myButton:active {
			position:relative;
			top:1px;
		}
		.leftArrow { position: absolute; bottom: 0; left: 0; font-size: xx-large; margin: 10px; }
		.rightArrow { position: absolute; bottom: 0; right: 0; font-size: xx-large; margin: 10px; }
		/*.pink { background: #6cf; } */
		.pink { background: #eee; }
		.green { background: #cff; }
		.blue { background: #cff; }
		.white { background: #fff; }
		.pysparkButton { position: absolute; bottom: 0; width: 100%; text-align: center; font-size: large; margin: 10px; }
		#pysparkResults { }
		.footer { height: 10px; text-align: center; font-size: small; }
		.advanced {
			position: fixed;
			bottom: 0;
			right: 0;
			padding: 10px;
			color: #a0a0a0;
		}			

	</style>
	<!-- this script will listen for button push and then execute cgi script and return data to user -->
	<script type="text/javascript">
		function onTest( dest, params ){
			var xmlhttp;
			if( window.XMLHttpRequest ){ // code for IE7+, Firefox, Chrome, Opera, Safari
			    xmlhttp=new XMLHttpRequest();
			} else { // code for IE6, IE5
			    xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
			}
			xmlhttp.onreadystatechange=function(){
			    if (xmlhttp.readyState==4 && xmlhttp.status==200){
				document.getElementById( "pysparkResults" ).innerHTML = xmlhttp.responseText;
			    }
			}
			xmlhttp.open("POST",dest,true);
			xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
			xmlhttp.send( params ); 
		}
	</script>

	</head>
	<body>	
	<div id="wrapper">
		<div class="header">Snow and Ice Data
			<div class="subtitle">
				<a href="http://nsidc.org/data/docs/daac/nsidc0001_ssmi_tbs.gd.html">DMSP SSM/I-SSMIS daily polar gridded brightness temperatures</a>
			</div><!--end subtitle-->
		</div><!--end header-->
<!-- menu -->	
		<div class="menu">
			<span id="dataExplorer">data-explorer</span>
		</div>
<!-- top box -->
		<div class="block pink">
			<div class="box figureLeftExplorer white">
				<br><br><span id="regionField">region</span><br>                
				<button id="north" class="myButton" id="northSouth" onclick="changeRegion('n')">north ↑</button>
				<button id="south" class="myButton" id="northSouth" onclick="changeRegion('s')">south ↓</button>
				
				<br><br><br><span id="frequencyField">frequency</span><br>
				<button id="91" class="myButton" id="frequencyChoice" onclick="changeFreq(91)">91.7</button>
				<button id="85" class="myButton" id="frequencyChoice" onclick="changeFreq(85)">85.5</button>
				<button id="37" class="myButton" id="frequencyChoice" onclick="changeFreq(37)">37.0</button>
				<button id="22" class="myButton" id="frequencyChoice" onclick="changeFreq(22)">22.2</button>
				<button id="19" class="myButton" id="frequencyChoice" onclick="changeFreq(19)">19.3</button>
				
				<br><br><br><span id="polarizationField">polarization</span><br>
				<button class="myButton" onclick="changePolarization('v')">vertical ↕</button>
				<button id="horizontal" class="myButton" onclick="changePolarization('h')">horizontal ↔</button>
				
				<br><br><br><span id="yearField">year</span><br>
				<button class="myButton" onClick="decrementYear()">← prev</button>
				<span id="yearEntry"></span>
				<button class="myButton" onClick="incrementYear()">next →</button>
				
				<br><br><br><span id="monthField">month</span><br>
				<button class="myButton" onClick="decrementMonth()">← prev</button>
				<span id="monthEntry"></span>
				<button class="myButton" onClick="incrementMonth()">next →</button>
				
				<br><br><br><span id="dayField">day</span><br>
				<button class="myButton" onClick="decrementDay()">← prev</button>
				<span id="dayEntry"></span>
				<button class="myButton" onClick="incrementDay()">next →</button>
				<br><br><br><br><br>
				<div id="imageInformation">
					<span id="outputImageTemperature">brightness temperature:</span><br>
					<span id="outputImageCoordinates">location:</span><br>
					<!--<span id="outputImageMin">min: </span><br>
					<span id="outputImageMax">max: </span><br> -->
					<span id="fileLabelName"></span>
				</div>			
			</div><!--end left-->
			
			<div class="box figureRightExplorer white">
				
				<canvas id="myCanvas" width="875" height="600" style="border: 1px solid black;">Canvas</canvas>
				<!--<div class="leftArrow" onclick="decrement()">←</div>
				<div class="rightArrow" onclick="increment()">→</div>
				<button onclick="threshold()">Threshold the image</button>-->
			</div><!--end center-->
		</div>
		<br>
		<div class="menu">
			<span id="sparkInterface">spark-interface</span>
		</div>
		<div class="block green">
			<div class="box figureLeftSpark white">
				python results generated each time button is pressed...
        			<div id="pysparkResults"><p id="pyspark">python</p></div>


			        <div class="pysparkButton"><a href="javascript:onTest('/cgi-bin/test.py', '')">run pyspark</a></div>
			</div><!--end center-->
			
			<div class="box figureRightSpark white">
				<br><br><br><br>
				dataset
				<br>
				[ seaice ] [ ssmi ]
				<br><br>
				evaluation method
				<br><br>
				[ temporal ]<br>
				start: year | month | day<br>
				end: year | month | day<br>
				<br><br>
				[ spatial ]<br>
				<form>
					columns<br>
					start<input type="text" name="c1"><br>
					end<input type="text" name="c2">
					<br><br>
					rows<br>
					start<input type="text" name="r1"><br>
					end<input type="text" name="r2">
				</form>
				<br>
				query
				<br><br>
				histogram
				<br><br>
				pixel-mapping
				<br><br>
				<br><br>

			</div><!--end right-->
		</div><!--end boxMiddle-->
		
		<div class="block footer">
			<p id="copyright">Copyright &#169
				<script type="text/javascript">
				<!--
				var currentTime = new Date()
				var year = currentTime.getFullYear()
				document.write(year)
				//-->
				</script>, by The Snow and Ice Data Center</p>
		</div><!--end footer-->
		
		<div class="advanced"><a onmouseover="this.innerHTML='advanced'" onmouseout="this.innerHTML='π'" href="http://104.154.87.138">π</a></div>
	</div><!--end wrapper-->
		
	<!-- decrement increment the image on canvas -->
	<script type="text/javascript">
		directory = "data/";
		region = "s";
		frequency = "91";
		polarization = "h";
		year = 2011; month = 10; day = 1;
		minimumTemperature = 50; maximumTemperature = 350;
		monthArray = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
		date = new Date();
		date.setFullYear(year, month, day); // year, month (0-based), day
		//date.setTime(date.getTime() + (86400*100));
		currentFileName = "data/south/2009/tb_f17_20111001_v4_s91h.bin";
		function decrement(){ // sub one from day
			date.setTime(date.getTime() - 86400000); updateImage();
		}
		function increment(){ // add one to the day
			date.setTime(date.getTime() + 86400000); updateImage();
		}
		function changeFreq(num){ frequency = num; updateImage(); }
		function changeRegion(reg) { region = reg; updateImage(); }
		function changePolarization(pol) { polarization = pol; updateImage(); }
		function updateDateFields(){
			document.getElementById("yearEntry").innerHTML = year;
			document.getElementById("monthEntry").innerHTML = monthArray[month];
			document.getElementById("dayEntry").innerHTML = day;
		}
		function updateImage(){
			console.log("currentFileName: ", currentFileName);
			dateString = date.getFullYear().toString()+('0'+(date.getMonth()+1)).slice(-2)+('0'+date.getDate()).slice(-2);
			year = date.getFullYear();
			month = date.getMonth();
			day = date.getDate();
			updateDateFields();
			var area = "south";
			region == "n"? area = "north": area = "south";
			currentFileName = directory + area + "/" + year + "/tb_f17_" + dateString + "_v4_" + region + frequency + polarization + ".bin";
			console.log("updatedFileName: ", currentFileName);
			document.getElementById("fileLabelName").innerHTML = "tb_f17_"+dateString+"_v4_"+region+frequency+polarization+".bin";
			
			var xhr = new XMLHttpRequest();
			xhr.open('GET', currentFileName, true);
			xhr.responseType = 'arraybuffer';

			xhr.onload = function(e){
				console.log("response: ", this.response);
				var responseArray = new Uint16Array(this.response);
				console.log("response array: ", responseArray);
				
				var c = document.getElementById("myCanvas");
				var ctx = c.getContext("2d");
        			var width = c.width;
				var height = c.height;
				ctx.clearRect(0, 0, c.width, c.height);
				
				// get size of image
				if( responseArray.length == 419648 ){ // south 664x632
					var imageHeight = 664; var imageWidth = 632;
				} else if( responseArray.length == 104912 ){ // south 332x316
					var imageHeight = 332; var imageWidth = 316;
				} else if( responseArray.length == 544768 ){ // north 896x608
					var imageHeght = 896; var imageWidth = 608;
				} else if( responseArray.length == 136192 ){ // north 448x304
					var imageHeight = 448; var imageWidth = 304;
				} else { // error of some sort
					document.getElementById( "fileLabelName" ).innerHTML = "No Files Available For These Parameters!";
					return;
				}
				
				var imgData = ctx.createImageData(imageWidth, imageHeight);
				for( var i = 0, j = 0; i < imgData.data.length; i+=4, j++ ){
					if( responseArray[j] == 0 ){ // missing data
						imgData.data[i+0] = 0;
						imgData.data[i+1] = 0;
						imgData.data[i+2] = 0;
						imgData.data[i+3] = 0;
					} else {
						imgData.data[i+0] = (responseArray[j]/10-50)/300*255;
						imgData.data[i+1] = (responseArray[j]/10-50)/300*255;
						imgData.data[i+2] = (responseArray[j]/10-50)/300*255;
						imgData.data[i+3] = 255;
					}
				}
				// update max min
				//minimumTemperature = Math.min.apply(null, responseArray); # some array problem
				//maximumTemperature = Math.max.apply(null, responseArray);
				//document.getElementById("outputImageMin").innerHTML = "min: " + minimumTemperature/10;
				//document.getElementById("outputImageMax").innerHTML = "max: " + maximumTemperature/10;
				ctx.putImageData(imgData,(width-imageWidth)/2,(height-imageWidth)/2);
				//ctx.putImageData(imgData,0,0);
			};
			xhr.send();
		}
		updateImage();

		// find pos and append to the plot
		function findPos( obj ){
			var current_left = 0, current_top = 0;
			if (obj.offsetParent){
				do{
					current_left += obj.offsetLeft;
					current_top += obj.offsetTop;
				} while( obj = obj.offsetParent );
				return {x: current_left, y: current_top};
			}
			return undefined;
		}
		function rgbToHex(r, g, b){
			if (r > 255 || g > 255 || b > 255)
				throw "Invalid color component";
			return ((r << 16) | (g << 8) | b).toString(16);
		}
		// output pixel info to screen
		$('#myCanvas').mousemove(function(e){
			var position = findPos(this);
			var x = e.pageX - position.x;
			var y = e.pageY - position.y;
			var coordinate = "location: x = " + x + ", y = " + y;
			var canvas = this.getContext('2d');
			var p = canvas.getImageData(x, y, 1, 1).data;
			//var hex = "#" + ("000000" + rgbToHex(p[0], p[1], p[2])).slice(-6);
			var temperature = Math.round( p[0]/255*300+50 );
			if( temperature == 50 ){
				document.getElementById("outputImageTemperature").innerHTML = "brightness temperature: ";
			} else {
				document.getElementById("outputImageTemperature").innerHTML = "brightness temperature: " + temperature + " K";
			}
			document.getElementById("outputImageCoordinates").innerHTML = coordinate.toString();
			//alert("HEX: " + hex);
		});
		$('#myCanvas').mouseout(function(e){
			document.getElementById( "outputImageTemperature" ).innerHTML = "brightness temperature: ";
			document.getElementById( "outputImageCoordinates" ).innerHTML = "location:";
		});
	</script>

	<!-- increment value of button -->
	<script type="text/javascript">
		window.onload = function(){
			//updateDateFields(){
		}
		function incrementYear(){
			if( (year) < 2014 ){
				date.setFullYear(year+1, month, day); // year, month (0-based), day
			}
			updateImage();
		}
		function decrementYear(){
			if( (year) > 2008 ){
				date.setFullYear(year-1, month, day); // year, month (0-based), day
			}
			updateImage();
		}
		function incrementMonth(){
			date.setFullYear(year, (month+1), day); // year, month (0-based), day
			updateImage();
		}
		function decrementMonth(){
			console.log('here again');
			date.setFullYear(year, (month-1), day); // year, month (0-based), day
			updateImage();
		}
		function incrementDay(){
			date.setFullYear(year, month, day+1); // year, month (0-based), day
			updateImage();
		}
		function decrementDay(){
			date.setFullYear(year, month, day-1); // year, month (0-based), day
			updateImage();
		}
		
	</script>

	<!-- Get files from folder. Usage: "_getAllFilesFromFolder(__dirname + "folder");" -->
	<script>
	
	</script>

	<!-- for convolution filter -->
	<script>
		Filters = {};
		Filters.getPixels = function(img) {
		  var c = this.getCanvas(img.width, img.height);
		  var ctx = c.getContext('2d');
		  ctx.drawImage(img);
		  return ctx.getImageData(0,0,c.width,c.height);
		};

		Filters.getCanvas = function(w,h) {
		  var c = document.createElement('canvas');
		  c.width = w;
		  c.height = h;
		  return c;
		};

		Filters.filterImage = function(filter, image, var_args) {
		  var args = [this.getPixels(image)];
		  for (var i=2; i<arguments.length; i++) {
		    args.push(arguments[i]);
		  }
		  return filter.apply(null, args);
		};
		
		Filters.threshold = function(pixels, threshold) {
		  var d = pixels.data;
		  for (var i=0; i<d.length; i+=4) {
		    var r = d[i];
		    var g = d[i+1];
		    var b = d[i+2];
		    var v = (0.2126*r + 0.7152*g + 0.0722*b >= threshold) ? 255 : 0;
		    d[i] = d[i+1] = d[i+2] = v
		  }
		  return pixels;
		};

	</script>

	</body>
</html>
